<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>TrendTracker – Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* DARK BACKGROUND */
    body {
      background-color: #1e293b; /* Medium BMW slate/blue */
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* NAVBAR */
    .navbar {
      background: linear-gradient(90deg, #0A1A44, #009FE3);
    }
    .navbar .nav-link {
      color: #e5e7eb;
      font-weight: 500;
    }
    .navbar .nav-link.active {
      background-color: rgba(255,255,255,0.2);
    }

    .brand-accent {
      color: white;
      font-weight: 700;
    }

    /* DARK CARDS */
    .card, .stat-card {
      background-color: #334155; /* Steel blue */
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.1);
      color: #f9fafb;
    }

    /* BMW BUTTONS */
    .btn-bmw {
      border: 2px solid #009FE3;
      color: #ffffff;
      background-color: #0A1A44;
      font-weight: 600;
    }
    .btn-bmw:hover {
      background-color: #009FE3;
      color: #ffffff;
    }

    /* HEADINGS */
    h4, h6 {
      color: #ffffff;
    }

  </style>
</head>

<body>

<!-- NAV -->
<nav class="navbar navbar-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand mb-0 h1" href="/">
      Trend<span class="brand-accent">Tracker</span>
    </a>
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/">Search</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.path.startswith('/watch') %}active{% endif %}" href="/watch">Watching</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.path == '/analytics' %}active{% endif %}" href="/analytics">Analytics</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.path == '/profile' %}active{% endif %}" href="/profile">Profile</a>
      </li>
    </ul>
  </div>
</nav>


<div class="container mb-5">

  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-lg-10 mx-auto">
      <div class="stat-card p-4">
        <h4 class="mb-3">Watchlist Analytics</h4>

        {% if not analytics_data.labels %}
          <p class="text-light mb-0">No watch rules yet. Add some on the Watching tab to generate analytics.</p>
        {% else %}
          <p class="text-light mb-0">Insights generated using your current watch rules and marketplace data.</p>
        {% endif %}
      </div>
    </div>
  </div>


  {% if analytics_data.labels %}

  <!-- ROW 1: AVG PRICE + PRICE DROP -->
  <div class="row mb-4">
    <div class="col-lg-6 mb-3">
      <div class="card p-3">
        <h6>Average Price by Watch Rule</h6>
        <canvas id="avgPriceChart"></canvas>
      </div>
    </div>
    <div class="col-lg-6 mb-3">
      <div class="card p-3">
        <h6>Price Drop (First → Latest)</h6>
        <canvas id="priceDropChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ROW 2: TREND -->
  <div class="row mb-4">
    <div class="col-lg-10 mx-auto">
      <div class="card p-3">
        <h6>Price Trend Over Time (All Watch Rules)</h6>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  {% endif %}

</div>


<!-- CHART LOGIC -->
<script>
  const labels = {{ analytics_data.labels | tojson }};
  const avgPrices = {{ analytics_data.avg_prices | tojson }};
  const drops = {{ analytics_data.price_drops | tojson }};
  const trendPoints = {{ analytics_data.trend_points | tojson }};

  // BMW M COLORS
  const bmwLightBlue = "#009FE3";
  const bmwDarkBlue = "#0A1A44";
  const bmwRed = "#D40000";

  /* AVG PRICE CHART */
  if (labels.length > 0) {
    new Chart(document.getElementById('avgPriceChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Average Price (USD)',
          data: avgPrices,
          backgroundColor: bmwLightBlue,
          borderColor: bmwDarkBlue,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    /* PRICE DROP CHART */
    new Chart(document.getElementById('priceDropChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Price Drop',
          data: drops,
          backgroundColor: bmwRed,
          borderColor: bmwLightBlue,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  /* TREND CHART */
  if (trendPoints.length > 0) {
    const trendLabels = trendPoints.map(p => p.date.substring(0, 10) + ' – ' + p.rule);
    const trendPrices = trendPoints.map(p => p.price);

    new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Price Over Time',
          data: trendPrices,
          borderColor: bmwLightBlue,
          backgroundColor: 'rgba(0,159,227,0.2)',
          borderWidth: 3,
          tension: 0.25,
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: false } }
      }
    });
  }
</script>


<!-- BOOTSTRAP -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
